<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chatBot</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <h1 class="title">禁煙くん</h1>
    <ul id="chat" class="chat"></ul>
    <div class="form">
      <input type="text" id="input" class="input">
      <button id="btn" class="btn">ボタン</button>
    </div>
  </div>
  
<script>
/////////////////////////////////
//////////  クラス  /////////////
/////////////////////////////////
class Chat {
  constructor() {
    this.messages = []
  }

  addMessage(message) {
    this.messages.push(message)
  }

  getMessages() {
    return this.messages
  }
}

class Input {
  constructor() {
    this.text = ''
  }
  
  addText(text) {
    this.text = text
  }

  getText() {
    return this.text;
  }
}

class Bot {
  constructor() {
    this.messages = {
      openMessage: ['こんにちわ',
                    '禁煙お助けBotの禁煙くんです。\n' + 
                    '\n' +
                    '禁煙を始める時は『禁煙開始』を入力してください。\n' +
                    '挫けそうになったら『辞めたい』を入力してくだい。\n' +
                    '経過時刻を知りたくなったら『時間』を入力してください。'],
      response:{
        first: ['わかりました。\n頑張りましょう。','はい、応援します！','応援３'],
        second: ['励まし１','励まし2','励まし3'],
        third: ['時刻１','時刻２','時刻３'],
        other: ['その他１','その他２','その他３','その他4','その他5',]
      }
    }
    this.pattern = [/禁煙開始/, /辞めたい/, /時間/]
  }

  getOpenMessage() {
    return this.messages.openMessage
  }

  getFirstResponse() {
    const index = this.randomNum(3)

    return this.messages.response.first[index] 
  }
  getSecondResponse() {
    const index = this.randomNum(3)

    return this.messages.response.second[index]
  }
  getThirdResponse() {
    const index = this.randomNum(3)

    return this.messages.response.third[index]
  }
  getOtherResponse() {
    const index = this.randomNum(5)

    return this.messages.response.other[index]
  }

  randomNum(maxNum) {
    return Math.floor( Math.random() * maxNum)
  }

  getPattern() {
    return this.pattern
  }
}

/////////////////////////////////
//////////  定数  /////////////
/////////////////////////////////
const chatArea = document.getElementById('chat')
const inputArea = document.getElementById('input')
const btn = document.getElementById('btn')
// userメッセージオブジェクトのテンプレート
const msgObj = {
  id: null,
  text: '', 
  person: 'user'
}
// botメッセージオブジェクトのテンプレート
const botObj = { 
  id: null,
  text: '', 
  person: 'bot'
}

const chat = new Chat()
const bot = new Bot()
const input = new Input()

/////////////////////////////////
//////////  イベント  /////////////
/////////////////////////////////
window.addEventListener('load', function() {
  // 1秒毎にbotMessageを表示
  delay(1000)
    .then(() => {
      id = chat.getMessages().length
      text = bot.getOpenMessage()[0]
      newObj = {...botObj}

      addObj(id, text, newObj)
    })

    .then(() => delay(1000))
    .then(() => {
      id = chat.getMessages().length
      text = bot.getOpenMessage()[1]
      newObj = {...botObj}

      addObj(id, text, newObj)
    })
})

inputArea.addEventListener('input', function(e) {
  
  input.addText(e.target.value);

})

btn.addEventListener('click', function() {
  const inputText = input.getText()
  if(!inputText) return

  const id = chat.getMessages().length
  const pattern = bot.getPattern()
  // Botクラスの持つ特定の文字列とパターン一致したbot.messagesを返す
  const patternData = getResponsePattern(inputText, pattern)
  let newObj

  inputArea.value = ''

  newObj = {...msgObj}
  addObj(id, inputText, newObj)

  delay(1000)
    .then(() => {
      const id = chat.getMessages().length
      newObj = {...botObj}
      addObj(id, patternData, newObj)
    })
})

///////////////////////////////
//////////  関数  /////////////
///////////////////////////////
function rendor() {
  const chats = chat.getMessages();
  if(chats.length === 0) return

  chatArea.innerHTML = ''

  chats.forEach(function(elm) {
    const elementContainer = document.createElement("li")
    const elementName = document.createElement("div")
    const elementText = document.createElement("p")

    const chatListStyle = (elm.person === 'user') ? 'chat-item--left' : 'chat-item--right'
    const nameListStyle = (elm.person === 'user') ? 'chat-item__name--left' : 'chat-item__name--right'
    const textListStyle = (elm.person === 'user') ? 'chat-item__text--left' : 'chat-item__text--right'

    elementContainer.classList.add('chat-item', chatListStyle)

    elementName.classList.add(nameListStyle)
    elementName.innerText = elm.person

    elementText.classList.add('chat-item__text', textListStyle)
    elementText.innerText = elm.text;
    

    elementContainer.appendChild(elementName)
    elementContainer.appendChild(elementText)

    chatArea.appendChild(elementContainer)
  })

  chatArea.scrollTop = chatArea.scrollHeight
}

function addObj(id, text, newObj) {
  newObj.id = id
  newObj.text = text

  chat.addMessage(newObj)

  rendor()
}

function getResponsePattern(inputText, pattern) {
  const keyword = pattern.find(keyword => inputText.match(keyword))
  const arrayMatch = inputText.match(keyword)
  let data = ''

  switch(arrayMatch[0]){
    case '禁煙開始':
      data = bot.getFirstResponse()
      break
    
    case '辞めたい':
      data =  bot.getSecondResponse()
      break
    
    case '時間':
      data = bot.getThirdResponse()
      break

    default:
      data = bot.getOtherResponse()
      break
  }

  return data
}

function delay(ms) {
  return new Promise( resolve => setTimeout(resolve, ms))
}
</script>
</body>
</html>